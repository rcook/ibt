#!/usr/bin/env python

###############################################################################
#
# IBT: Isolated Build Tool
# Copyright (C) 2016, Richard Cook. All rights reserved.
#
# Simple wrappers around Docker etc. for fully isolated build environments
#
###############################################################################

import os
import shlex
import sys

from ibtimpl.context import *
from ibtimpl.docker_util import *
from ibtimpl.help_command import *
from ibtimpl.project_info import *
from ibtimpl.run_command import *
from ibtimpl.status_command import *

HELP_COMMAND = HelpCommand()
RUN_COMMAND = RunCommand()

def show_usage(ctx):
    HELP_COMMAND.run(ctx, [])

def run_command(ctx, argv):
    name = argv[0]
    command = get_commands().get(name, None)
    if command is None:
        print("Unrecognized command \"{}\"!\n".format(name))
        show_usage(ctx)
        return

    args = command.parser.parse_args(argv[1 : ])
    command.run(ctx, args)

def main_inner(ctx, argv):
    if len(argv) < 2:
        show_usage(ctx)
        return

    name = argv[1]
    aliases = ctx.settings.get("aliases", None)
    alias = None if aliases is None else aliases.get(name, None)
    if alias is None:
        run_command(ctx, argv[1 : ])
    elif isinstance(alias, list):
        RUN_COMMAND.run_lines(ctx, alias)
    else:
        run_command(ctx, shlex.split(alias))

def main(dir, argv):
    if not docker_installed():
        print("Please install Docker")
        return

    project_info = ProjectInfo.read(dir)
    if project_info is None:
        print("No Ibtfile project configuration file could be found")
        return

    ctx = Context(project_info, dir)

    # Special-case the "status" command to report status even
    # if .ibt directory has not been created yet
    if not os.path.isdir(ctx.dot_dir) and argv[1 : ] == ["status"]:
        StatusCommand().run(ctx, [])
        return

    main_inner(ctx, argv)

if __name__ == "__main__":
    main(os.getcwd(), sys.argv)
